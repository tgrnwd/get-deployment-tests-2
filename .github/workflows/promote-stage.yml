name: "Promote to Stage"
on:
  workflow_dispatch:

jobs:
  get-deployment:
    runs-on: ubuntu-latest
    outputs:
      sha: ${{ steps.get-deployment-action.outputs.sha }}
      ref: ${{ steps.get-deployment-action.outputs.ref }}
    steps:
      - uses: tgrnwd/get-deployment@v1
        id: get-deployment-action
        with:
          token: ${{ secrets.GITHUB_TOKEN  }}
          environment: demo

      - name: Download artifact
        uses: dawidd6/action-download-artifact@v2
        with:
          github_token: ${{secrets.GITHUB_TOKEN}}
          commit: ${{ steps.get-deployment-action.outputs.sha }}
          workflow: build.yml
          workflow_conclusion: success
          name: timestamp.txt

      - name: Get current draft release version and upload URL
        run: |
          RELEASE_VERSION=$(hub release -f "%T (%S) %n" --include-drafts | grep " (draft)" | awk '{print $1}' | xargs -t -n1 echo)
          echo "RELEASE_VERSION=$(echo $RELEASE_VERSION)" >> $GITHUB_ENV
          echo "RELEASE_UPLOADURL=$(hub release show $RELEASE_VERSION --format '%uA')" >> $GITHUB_ENV
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload Release Asset
        id: upload-release-asset 
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GH_RELEASE_TOKEN }}
        with:
          upload_url: ${{ env.RELEASE_UPLOADURL }}
          asset_path: ./timestamp.txt
          asset_name: timestamp.txt
          asset_content_type: text/plain

      - name: Change current draft release to prerelease
        run: hub release edit ${{ env.RELEASE_VERSION }} --draft=false -m ""
        env:
          GITHUB_TOKEN: ${{ secrets.GH_RELEASE_TOKEN }}